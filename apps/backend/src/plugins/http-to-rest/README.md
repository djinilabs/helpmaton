# HTTP to REST API Transformation Plugin

This Architect plugin transforms HTTP API v2 integrations to REST API integrations in the CloudFormation template generated by Architect. The transformation maintains all existing features, security policies, routes, and domain configurations with minimal changes.

## Overview

The plugin automatically converts:
- `AWS::ApiGatewayV2::Api` → `AWS::ApiGateway::RestApi`
- HTTP API v2 routes → REST API resources and methods
- HTTP API v2 integrations → REST API method integrations
- HTTP API v2 stages → REST API stages and deployments
- HTTP API v2 authorizers → REST API authorizers
- HTTP API v2 custom domains → REST API domain names and base path mappings

## Installation

The plugin is already configured in `app.arc`:

```arc
@plugins
http-to-rest
custom-domain
```

**Important**: The `http-to-rest` plugin must be listed **before** the `custom-domain` plugin to ensure proper transformation order.

## Configuration

The plugin requires no configuration. It automatically detects HTTP API v2 resources and transforms them to REST API.

### Feature Flag (Optional)

To enable/disable the transformation via environment variable, you can modify the plugin to check for an environment variable:

```bash
export ENABLE_REST_API_TRANSFORMATION=true
```

Currently, the plugin always transforms when HTTP API v2 is detected. To add a feature flag, modify `index.js`:

```javascript
if (process.env.ENABLE_REST_API_TRANSFORMATION === 'false') {
  return cloudformation;
}
```

## How It Works

1. **Detection**: The plugin checks if the CloudFormation template contains `AWS::ApiGatewayV2::Api` resources
2. **Transformation**: If found, it transforms all HTTP API v2 resources to REST API equivalents
3. **Preservation**: All Lambda function references, authorizers, and domain configurations are preserved
4. **Cleanup**: HTTP API v2 resources are removed after transformation

## Transformation Details

### Routes

- Simple routes: `GET /api/usage` → REST API method on `/api/usage` resource
- Path parameters: `POST /api/webhook/:workspaceId/:agentId/:key` → REST API method with `{workspaceId}`, `{agentId}`, `{key}` path parameters
- Wildcards: `ANY /api/auth/*` → REST API method on `/api/auth/{proxy+}` resource
- Catch-all: `ANY /*` → REST API method on `/{proxy+}` resource

### Methods

- `ANY` methods are expanded to all HTTP methods: GET, POST, PUT, DELETE, PATCH, HEAD, OPTIONS
- Integration type is set to `AWS_PROXY` (Lambda proxy integration)
- Integration URIs are preserved from HTTP API v2 integrations

### Authorizers

- JWT authorizers → REST API `COGNITO_USER_POOLS` authorizers
- Lambda/REQUEST authorizers → REST API `TOKEN` authorizers
- IAM authorizers → REST API methods with `AuthorizationType: AWS_IAM`

### Custom Domains

- HTTP API v2 domain configuration → REST API `DomainName` and `BasePathMapping` resources
- Route53 records are preserved if configured
- Certificate ARNs are maintained

## Compatibility

### Handler Compatibility

The existing `adaptHttpHandler` utility in `apps/backend/src/utils/httpEventAdapter.ts` already supports REST API events, so handlers work without modification.

### Plugin Compatibility

- **custom-domain plugin**: Updated to work with both HTTP API v2 and REST API
- **Other plugins**: Should work unchanged as the REST API resource ID remains `HTTP`

## Testing

Run unit tests:

```bash
cd apps/backend
pnpm test -- src/plugins/http-to-rest/__tests__
```

Run all tests:

```bash
pnpm test
```

## Migration Guide

See [MIGRATION.md](./MIGRATION.md) for detailed migration instructions.

## Troubleshooting

See [TROUBLESHOOTING.md](./TROUBLESHOOTING.md) for common issues and solutions.

## Limitations

1. **Breaking Change**: The first deployment will replace HTTP API v2 with REST API, which is a breaking change. Plan for downtime or use blue-green deployment.

2. **API Endpoints**: REST API endpoints have a different format than HTTP API v2:
   - HTTP API v2: `https://{api-id}.execute-api.{region}.amazonaws.com`
   - REST API: `https://{api-id}.execute-api.{region}.amazonaws.com/{stage}`
   - Custom domains remain the same

3. **Cost**: REST API pricing differs from HTTP API v2. HTTP API v2 is generally cheaper.

4. **CORS**: REST API CORS configuration differs from HTTP API v2. You may need to add CORS methods and headers explicitly.

## References

- [Architect Plugin Documentation](https://arc.codes/docs/en/guides/plugins)
- [AWS API Gateway REST API CloudFormation Reference](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/AWS_ApiGateway.html)
- [AWS API Gateway HTTP API v2 CloudFormation Reference](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/AWS_ApiGatewayV2.html)

