name: Deploy PR

on:
  pull_request:
    types: [opened, reopened, synchronize]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to deploy"
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Security: Explicit permissions - only what's needed
    permissions:
      contents: read
      pull-requests: read
      actions: read
      id-token: write
    # Only run on PR events or manual dispatch
    if: |
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch'
    concurrency:
      group: deploy-pr-${{ github.event.pull_request.number || github.event.inputs.pr_number || 'unknown' }}
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v6

      - name: Get PR number
        id: pr-info
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
          else
            echo "‚ùå Unexpected event type: ${{ github.event_name }}"
            echo "This workflow should be triggered from a pull_request event or workflow_dispatch"
            exit 1
          fi
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "PR_NUMBER=${PR_NUMBER}" >> $GITHUB_ENV
          echo "PR number: ${PR_NUMBER}"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-2

      - name: Enable pnpm corepack
        run: corepack enable

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.26.1

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v5
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Use Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build backend (for Docker images)
        env:
          NODE_ENV: "production"
          VITE_ENV: "production"
          ARC_ENV: "staging"
          NODE_OPTIONS: "--enable-source-maps --max_old_space_size=32768"
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
          MAILGUN_KEY: ${{ secrets.MAILGUN_KEY }}
          MAILGUN_DOMAIN: "helpmaton.com"
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          AWS_PR_DEPLOY_CERTIFICATE_ARN: ${{ secrets.AWS_PR_DEPLOY_CERTIFICATE_ARN }}
          AWS_CLOUDFRONT_CERTIFICATE_ARN: ${{ secrets.AWS_CLOUDFRONT_CERTIFICATE_ARN }}
          AWS_ZONE_ID: ${{ secrets.AWS_ZONE_ID }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          HELPMATON_S3_BUCKET: ${{ secrets.HELPMATON_PR_ENV_S3_BUCKET }}
          HELPMATON_S3_ENDPOINT: ${{ secrets.HELPMATON_S3_ENDPOINT }}
          HELPMATON_S3_ACCESS_KEY_ID: ${{ secrets.HELPMATON_S3_ACCESS_KEY_ID }}
          HELPMATON_S3_SECRET_ACCESS_KEY: ${{ secrets.HELPMATON_S3_SECRET_ACCESS_KEY }}
          HELPMATON_S3_REGION: ${{ secrets.HELPMATON_S3_REGION }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          CLOUDFLARE_TURNSTILE_SECRET_KEY: ${{ secrets.CLOUDFLARE_TURNSTILE_SECRET_KEY }}
          CLOUDFLARE_TURNSTILE_SITE_KEY: ${{ secrets.CLOUDFLARE_TURNSTILE_SITE_KEY }}
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_CS_BOT_TOKEN }}
          DISCORD_TRIAL_CREDIT_CHANNEL_ID: ${{ secrets.DISCORD_TRIAL_CREDIT_CHANNEL_ID }}
          ENABLE_CREDIT_VALIDATION: "false"
          ENABLE_CREDIT_DEDUCTION: "false"
          ENABLE_SPENDING_LIMIT_CHECKS: "false"
          DISCORD_PUBLIC_KEY: ${{ secrets.DISCORD_PUBLIC_KEY }}
          DISCORD_CS_USERS: ${{ secrets.DISCORD_CS_USERS }}
          GMAIL_CLIENT_ID: ${{ secrets.GMAIL_CLIENT_ID }}
          GMAIL_CLIENT_SECRET: ${{ secrets.GMAIL_CLIENT_SECRET }}
          OUTLOOK_CLIENT_ID: ${{ secrets.OUTLOOK_CLIENT_ID }}
          OUTLOOK_CLIENT_SECRET: ${{ secrets.OUTLOOK_CLIENT_SECRET }}
          LEMON_SQUEEZY_API_KEY: ${{ secrets.LEMON_SQUEEZY_API_KEY }}
          LEMON_SQUEEZY_WEBHOOK_SECRET: ${{ secrets.LEMON_SQUEEZY_WEBHOOK_SECRET }}
          LEMON_SQUEEZY_STORE_ID: ${{ secrets.LEMON_SQUEEZY_STORE_ID }}
          LEMON_SQUEEZY_STARTER_VARIANT_ID: ${{ secrets.LEMON_SQUEEZY_STARTER_VARIANT_ID }}
          LEMON_SQUEEZY_PRO_VARIANT_ID: ${{ secrets.LEMON_SQUEEZY_PRO_VARIANT_ID }}
          LEMON_SQUEEZY_CREDIT_VARIANT_ID: ${{ secrets.LEMON_SQUEEZY_CREDIT_VARIANT_ID }}
          LEMON_SQUEEZY_CHECKOUT_SUCCESS_URL: ${{ secrets.LEMON_SQUEEZY_CHECKOUT_SUCCESS_URL }}
          LEMON_SQUEEZY_CHECKOUT_CANCEL_URL: ${{ secrets.LEMON_SQUEEZY_CHECKOUT_CANCEL_URL }}
          HELPMATON_VECTORDB_S3_BUCKET_STAGING: ${{ secrets.HELPMATON_VECTORDB_S3_BUCKET_STAGING }}
          E2E_OVERRIDE_MAX_USERS: "10"
        run: |
          PR_NUMBER="${PR_NUMBER:-${{ steps.pr-info.outputs.pr_number }}}"
          # Set URL environment variables using PR_NUMBER (needed for build)
          export BASE_URL="https://${PR_NUMBER}.helpmaton.com"
          export HELPMATON_CUSTOM_DOMAIN="${PR_NUMBER}.helpmaton.com"
          export OAUTH_REDIRECT_BASE_URL="https://${PR_NUMBER}.helpmaton.com"
          export FRONTEND_URL="https://${PR_NUMBER}.helpmaton.com"
          export AWS_CERTIFICATE_ARN="${AWS_PR_DEPLOY_CERTIFICATE_ARN}"
          pnpm build:backend

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Build and push Lambda container images
        env:
          AWS_REGION: eu-west-2
          LAMBDA_IMAGES_ECR_REPOSITORY: helpmaton-lambda-images
          LAMBDA_IMAGE_TAG: ${{ github.sha }}
        run: |
          bash scripts/build-and-push-lambda-images.sh

      - name: Wait for Tests workflow to complete
        id: check-tests
        uses: actions/github-script@v8
        with:
          script: |
            const maxAttempts = 60; // 60 attempts
            const waitTime = 10000; // 10 seconds between attempts = max 10 minutes wait
            const headSha = context.payload.pull_request?.head?.sha || context.sha;

            console.log(`Waiting for Tests workflow to complete for commit: ${headSha}`);

            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              const { data: runs } = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'test.yml',
                head_sha: headSha,
                per_page: 1,
              });

              if (runs.workflow_runs.length === 0) {
                if (attempt === 1) {
                  console.log(`No Tests workflow run found yet. Waiting... (attempt ${attempt}/${maxAttempts})`);
                  await new Promise(resolve => setTimeout(resolve, waitTime));
                  continue;
                } else {
                  core.setFailed('No Tests workflow run found for this commit after waiting. Please ensure tests are running.');
                  return;
                }
              }

              const testRun = runs.workflow_runs[0];
              console.log(`Tests workflow status: ${testRun.status}, conclusion: ${testRun.conclusion || 'pending'} (attempt ${attempt}/${maxAttempts})`);

              if (testRun.status === 'completed') {
                if (testRun.conclusion === 'success') {
                  console.log(`‚úÖ Tests workflow passed (run ID: ${testRun.id})`);
                  core.setOutput('tests_passed', 'true');
                  return;
                } else {
                  core.setFailed(`Tests workflow did not pass (conclusion: ${testRun.conclusion}). Deployment cancelled.`);
                  return;
                }
              }

              // Still running, wait and retry
              if (attempt < maxAttempts) {
                console.log(`Tests workflow still running. Waiting ${waitTime/1000} seconds before next check...`);
                await new Promise(resolve => setTimeout(resolve, waitTime));
              }
            }

            // If we get here, we've exhausted all attempts
            core.setFailed('Tests workflow did not complete within the maximum wait time (10 minutes).');

      - name: Deploy PR
        env:
          NODE_ENV: "production"
          VITE_ENV: "production"
          NODE_OPTIONS: "--enable-source-maps --max_old_space_size=32768"
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
          MAILGUN_KEY: ${{ secrets.MAILGUN_KEY }}
          MAILGUN_DOMAIN: "helpmaton.com"
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          AWS_PR_DEPLOY_CERTIFICATE_ARN: ${{ secrets.AWS_PR_DEPLOY_CERTIFICATE_ARN }}
          AWS_CLOUDFRONT_CERTIFICATE_ARN: ${{ secrets.AWS_CLOUDFRONT_CERTIFICATE_ARN }}
          AWS_ZONE_ID: ${{ secrets.AWS_ZONE_ID }}
          HELPMATON_S3_BUCKET: ${{ secrets.HELPMATON_PR_ENV_S3_BUCKET }}
          HELPMATON_S3_ENDPOINT: ${{ secrets.HELPMATON_S3_ENDPOINT }}
          HELPMATON_S3_ACCESS_KEY_ID: ${{ secrets.HELPMATON_S3_ACCESS_KEY_ID }}
          HELPMATON_S3_SECRET_ACCESS_KEY: ${{ secrets.HELPMATON_S3_SECRET_ACCESS_KEY }}
          HELPMATON_S3_REGION: ${{ secrets.HELPMATON_S3_REGION }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          VITE_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          CLOUDFLARE_TURNSTILE_SECRET_KEY: ${{ secrets.CLOUDFLARE_TURNSTILE_SECRET_KEY }}
          CLOUDFLARE_TURNSTILE_SITE_KEY: ${{ secrets.CLOUDFLARE_TURNSTILE_SITE_KEY }}
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_CS_BOT_TOKEN }}
          DISCORD_TRIAL_CREDIT_CHANNEL_ID: ${{ secrets.DISCORD_TRIAL_CREDIT_CHANNEL_ID }}
          ENABLE_CREDIT_VALIDATION: "false"
          ENABLE_CREDIT_DEDUCTION: "false"
          ENABLE_SPENDING_LIMIT_CHECKS: "false"
          DISCORD_PUBLIC_KEY: ${{ secrets.DISCORD_PUBLIC_KEY }}
          DISCORD_CS_USERS: ${{ secrets.DISCORD_CS_USERS }}
          GMAIL_CLIENT_ID: ${{ secrets.GMAIL_CLIENT_ID }}
          GMAIL_CLIENT_SECRET: ${{ secrets.GMAIL_CLIENT_SECRET }}
          OUTLOOK_CLIENT_ID: ${{ secrets.OUTLOOK_CLIENT_ID }}
          OUTLOOK_CLIENT_SECRET: ${{ secrets.OUTLOOK_CLIENT_SECRET }}
          LEMON_SQUEEZY_API_KEY: ${{ secrets.LEMON_SQUEEZY_TEST_API_KEY }}
          LEMON_SQUEEZY_WEBHOOK_SECRET: ${{ secrets.LEMON_SQUEEZY_TEST_WEBHOOK_SECRET }}
          LEMON_SQUEEZY_STORE_ID: ${{ secrets.LEMON_SQUEEZY_TEST_STORE_ID }}
          LEMON_SQUEEZY_STARTER_VARIANT_ID: ${{ secrets.LEMON_SQUEEZY_TEST_STARTER_VARIANT_ID }}
          LEMON_SQUEEZY_PRO_VARIANT_ID: ${{ secrets.LEMON_SQUEEZY_TEST_PRO_VARIANT_ID }}
          LEMON_SQUEEZY_CREDIT_VARIANT_ID: ${{ secrets.LEMON_SQUEEZY_TEST_CREDIT_VARIANT_ID }}
          LEMON_SQUEEZY_CHECKOUT_SUCCESS_URL: ${{ secrets.LEMON_SQUEEZY_TEST_CHECKOUT_SUCCESS_URL }}
          LEMON_SQUEEZY_CHECKOUT_CANCEL_URL: ${{ secrets.LEMON_SQUEEZY_TEST_CHECKOUT_CANCEL_URL }}
          HELPMATON_VECTORDB_S3_BUCKET_STAGING: ${{ secrets.HELPMATON_VECTORDB_S3_BUCKET_STAGING }}
          E2E_OVERRIDE_MAX_USERS: "10"
        run: |
          PR_NUMBER="${PR_NUMBER:-${{ steps.pr-info.outputs.pr_number }}}"
          echo "‚úÖ Deploying PR"

          # Set URL environment variables using PR_NUMBER
          export BASE_URL="https://${PR_NUMBER}.helpmaton.com"
          export HELPMATON_CUSTOM_DOMAIN="${PR_NUMBER}.helpmaton.com"
          export OAUTH_REDIRECT_BASE_URL="https://${PR_NUMBER}.helpmaton.com"
          export FRONTEND_URL="https://${PR_NUMBER}.helpmaton.com"

          echo "‚úÖ BASE_URL: ${BASE_URL}"
          echo "‚úÖ HELPMATON_CUSTOM_DOMAIN: ${HELPMATON_CUSTOM_DOMAIN}"
          echo "‚úÖ OAUTH_REDIRECT_BASE_URL: ${OAUTH_REDIRECT_BASE_URL}"
          echo "‚úÖ FRONTEND_URL: ${FRONTEND_URL}"

          cd apps/backend
          export PATH=../../node_modules/.bin:$PATH
          export AWS_CERTIFICATE_ARN="${AWS_PR_DEPLOY_CERTIFICATE_ARN}"

          # Build array of environment variables to set in batch
          ENV_VARS=(
            AUTH_SECRET "${AUTH_SECRET}"
            MAILGUN_KEY "${MAILGUN_KEY}"
            BASE_URL "${BASE_URL}"
            GEMINI_API_KEY "${GEMINI_API_KEY}"
            HELPMATON_CUSTOM_DOMAIN "${HELPMATON_CUSTOM_DOMAIN}"
            OAUTH_REDIRECT_BASE_URL "${OAUTH_REDIRECT_BASE_URL}"
            FRONTEND_URL "${FRONTEND_URL}"
            AWS_CERTIFICATE_ARN "${AWS_PR_DEPLOY_CERTIFICATE_ARN}"
            AWS_ZONE_ID "${AWS_ZONE_ID}"
            ENABLE_CREDIT_VALIDATION "${ENABLE_CREDIT_VALIDATION}"
            ENABLE_CREDIT_DEDUCTION "${ENABLE_CREDIT_DEDUCTION}"
            ENABLE_SPENDING_LIMIT_CHECKS "${ENABLE_SPENDING_LIMIT_CHECKS}"
          )

          # Add conditional variables if they're set
          [ -n "${MAILGUN_DOMAIN}" ] && ENV_VARS+=(MAILGUN_DOMAIN "${MAILGUN_DOMAIN}")
          [ -n "${HELPMATON_S3_BUCKET}" ] && ENV_VARS+=(HELPMATON_S3_BUCKET "${HELPMATON_S3_BUCKET}")
          [ -n "${HELPMATON_S3_ACCESS_KEY_ID}" ] && ENV_VARS+=(HELPMATON_S3_ACCESS_KEY_ID "${HELPMATON_S3_ACCESS_KEY_ID}")
          [ -n "${HELPMATON_S3_SECRET_ACCESS_KEY}" ] && ENV_VARS+=(HELPMATON_S3_SECRET_ACCESS_KEY "${HELPMATON_S3_SECRET_ACCESS_KEY}")
          [ -n "${HELPMATON_S3_REGION}" ] && ENV_VARS+=(HELPMATON_S3_REGION "${HELPMATON_S3_REGION}")
          [ -n "${HELPMATON_S3_ENDPOINT}" ] && ENV_VARS+=(HELPMATON_S3_ENDPOINT "${HELPMATON_S3_ENDPOINT}")
          [ -n "${SENTRY_DSN}" ] && ENV_VARS+=(SENTRY_DSN "${SENTRY_DSN}")
          [ -n "${DISCORD_PUBLIC_KEY}" ] && ENV_VARS+=(DISCORD_PUBLIC_KEY "${DISCORD_PUBLIC_KEY}")
          [ -n "${DISCORD_CS_USERS}" ] && ENV_VARS+=(DISCORD_CS_USERS "${DISCORD_CS_USERS}")
          [ -n "${GMAIL_CLIENT_ID}" ] && ENV_VARS+=(GMAIL_CLIENT_ID "${GMAIL_CLIENT_ID}")
          [ -n "${GMAIL_CLIENT_SECRET}" ] && ENV_VARS+=(GMAIL_CLIENT_SECRET "${GMAIL_CLIENT_SECRET}")
          [ -n "${OUTLOOK_CLIENT_ID}" ] && ENV_VARS+=(OUTLOOK_CLIENT_ID "${OUTLOOK_CLIENT_ID}")
          [ -n "${OUTLOOK_CLIENT_SECRET}" ] && ENV_VARS+=(OUTLOOK_CLIENT_SECRET "${OUTLOOK_CLIENT_SECRET}")
          [ -n "${CLOUDFLARE_TURNSTILE_SECRET_KEY}" ] && ENV_VARS+=(CLOUDFLARE_TURNSTILE_SECRET_KEY "${CLOUDFLARE_TURNSTILE_SECRET_KEY}")
          [ -n "${DISCORD_BOT_TOKEN}" ] && ENV_VARS+=(DISCORD_BOT_TOKEN "${DISCORD_BOT_TOKEN}")
          [ -n "${DISCORD_TRIAL_CREDIT_CHANNEL_ID}" ] && ENV_VARS+=(DISCORD_TRIAL_CREDIT_CHANNEL_ID "${DISCORD_TRIAL_CREDIT_CHANNEL_ID}")
          [ -n "${LEMON_SQUEEZY_API_KEY}" ] && ENV_VARS+=(LEMON_SQUEEZY_API_KEY "${LEMON_SQUEEZY_API_KEY}")
          [ -n "${LEMON_SQUEEZY_WEBHOOK_SECRET}" ] && ENV_VARS+=(LEMON_SQUEEZY_WEBHOOK_SECRET "${LEMON_SQUEEZY_WEBHOOK_SECRET}")
          [ -n "${LEMON_SQUEEZY_STORE_ID}" ] && ENV_VARS+=(LEMON_SQUEEZY_STORE_ID "${LEMON_SQUEEZY_STORE_ID}")
          [ -n "${LEMON_SQUEEZY_STARTER_VARIANT_ID}" ] && ENV_VARS+=(LEMON_SQUEEZY_STARTER_VARIANT_ID "${LEMON_SQUEEZY_STARTER_VARIANT_ID}")
          [ -n "${LEMON_SQUEEZY_PRO_VARIANT_ID}" ] && ENV_VARS+=(LEMON_SQUEEZY_PRO_VARIANT_ID "${LEMON_SQUEEZY_PRO_VARIANT_ID}")
          [ -n "${LEMON_SQUEEZY_CREDIT_VARIANT_ID}" ] && ENV_VARS+=(LEMON_SQUEEZY_CREDIT_VARIANT_ID "${LEMON_SQUEEZY_CREDIT_VARIANT_ID}")
          [ -n "${LEMON_SQUEEZY_CHECKOUT_SUCCESS_URL}" ] && ENV_VARS+=(LEMON_SQUEEZY_CHECKOUT_SUCCESS_URL "${LEMON_SQUEEZY_CHECKOUT_SUCCESS_URL}")
          [ -n "${LEMON_SQUEEZY_CHECKOUT_CANCEL_URL}" ] && ENV_VARS+=(LEMON_SQUEEZY_CHECKOUT_CANCEL_URL "${LEMON_SQUEEZY_CHECKOUT_CANCEL_URL}")
          [ -n "${HELPMATON_VECTORDB_S3_BUCKET_STAGING}" ] && ENV_VARS+=(HELPMATON_VECTORDB_S3_BUCKET_STAGING "${HELPMATON_VECTORDB_S3_BUCKET_STAGING}")
          [ -n "${E2E_OVERRIDE_MAX_USERS}" ] && ENV_VARS+=(E2E_OVERRIDE_MAX_USERS "${E2E_OVERRIDE_MAX_USERS}")

          # Environment variables are now injected directly into Lambda bundles at build time
          # via esbuild's define option (see esbuild-config.cjs). This ensures each PR deployment
          # has isolated environment variables without relying on SSM Parameter Store.
          # All environment variables set in the 'env:' section above will be automatically
          # injected during the build process.
          echo "üìù Environment variables will be injected into Lambda bundles at build time..."

          cd ../..
          # Verify Cloudflare Turnstile environment variable is set
          if [ -z "${CLOUDFLARE_TURNSTILE_SITE_KEY}" ]; then
            echo "‚ö†Ô∏è  Warning: CLOUDFLARE_TURNSTILE_SITE_KEY is not set. CAPTCHA will not work."
          else
            echo "‚úÖ CLOUDFLARE_TURNSTILE_SITE_KEY is set (length: ${#CLOUDFLARE_TURNSTILE_SITE_KEY})"
          fi
          pnpm build
          cd apps/backend

          # Set ARC_STACK_NAME so the lambda-urls plugin can determine the DNS name at plugin time
          export ARC_STACK_NAME="HelpmatonStagingPR${PR_NUMBER}"
          export LAMBDA_IMAGE_TAG="${{ github.sha }}"
          export LAMBDA_IMAGES_ECR_REPOSITORY="helpmaton-lambda-images"
          pnpm arc deploy --name "PR${PR_NUMBER}" --staging --no-hydrate --verbose

      - name: Trigger API Gateway deployment
        run: |
          PR_NUMBER="${PR_NUMBER:-${{ steps.pr-info.outputs.pr_number }}}"
          echo "üöÄ Triggering API Gateway deployment to make changes live..."
          bash scripts/deploy-api-gateway.sh "HelpmatonStagingPR${PR_NUMBER}"
